{% extends 'base.html' %}

{% block title %}{{ title }} - Система экстренного обратного вызова{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-plus-circle text-success"></i> {{ title }}</h1>
        <p class="text-muted mb-0">Создать новый запрос экстренного обратного вызова</p>
    </div>
    <a href="{% url 'callbacks:list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Назад
    </a>
</div>

<div class="row g-4">
    <!-- Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-telephone-plus"></i> Детали запроса</h6>
            </div>
            <div class="card-body">
                <form method="post" id="callbackForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="id_phone_number" class="form-label fw-semibold">
                            <i class="bi bi-telephone text-primary"></i> Номер телефона
                        </label>
                        {{ form.phone_number }}
                        {% if form.phone_number.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.phone_number.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.phone_number.help_text }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="id_team" class="form-label fw-semibold">
                            <i class="bi bi-people text-primary"></i> Экстренная бригада
                        </label>
                        {{ form.team }}
                        {% if form.team.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.team.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.team.help_text }}</div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Что происходит дальше?</h6>
                        <ol class="mb-0 small">
                            <li>Система автоматически звонит пациенту</li>
                            <li>Пациент оценивает качество обслуживания (1-5 звезд)</li>
                            <li>Возможность перевода на оператора при необходимости</li>
                            <li>Данные сохраняются для анализа качества</li>
                        </ol>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'callbacks:list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-telephone-outbound"></i> Создать запрос
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Today's Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart text-info"></i> Сегодня</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="h4 text-primary">{{ today_calls|default:0 }}</div>
                        <div class="small text-muted">Вызовов</div>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-success">{{ today_completed|default:0 }}</div>
                        <div class="small text-muted">Завершено</div>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-warning">{{ today_ratings|default:0 }}</div>
                        <div class="small text-muted">Оценок</div>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-info">{{ today_success_rate|default:0 }}%</div>
                        <div class="small text-muted">Успешность</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> Рекомендации</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="small fw-semibold">Телефонные номера:</h6>
                    <ul class="small list-unstyled">
                        <li><i class="bi bi-check text-success"></i> Указывайте код страны (+998)</li>
                        <li><i class="bi bi-check text-success"></i> Проверяйте номер перед отправкой</li>
                        <li><i class="bi bi-check text-success"></i> Предпочтительны мобильные номера</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <h6 class="small fw-semibold">Оптимальное время:</h6>
                    <ul class="small list-unstyled">
                        <li><i class="bi bi-sun text-warning"></i> Будни: 9:00-18:00</li>
                        <li><i class="bi bi-moon text-secondary"></i> Избегайте раннего утра</li>
                    </ul>
                </div>

                <div>
                    <h6 class="small fw-semibold">Система оценок:</h6>
                    <div class="small">
                        <div>⭐ - Очень плохо</div>
                        <div>⭐⭐⭐ - Средне</div>
                        <div>⭐⭐⭐⭐⭐ - Отлично</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.getElementById('callbackForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const phone = document.getElementById('id_phone_number').value.trim();
    const team = document.getElementById('id_team').value;
    const submitBtn = this.querySelector('button[type="submit"]');

    // Basic validation
    if (!phone || !team) {
        App.toast('Заполните все обязательные поля', 'error');
        return;
    }

    // Confirmation
    const teamName = document.getElementById('id_team').selectedOptions[0].text;
    if (!confirm(`Создать запрос для ${phone}?\nБригада: ${teamName}\n\nСистема немедленно позвонит по этому номеру.`)) {
        return;
    }

    App.loading(submitBtn, true);

    setTimeout(() => {
        this.submit();
    }, 1000);
});

// Phone number formatting
document.getElementById('id_phone_number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d+]/g, '');

    // Auto-format Uzbekistan numbers
    if (value.startsWith('9') && value.length === 9) {
        value = '998' + value;
    }

    e.target.value = value;
});
</script>
{% endblock %}
{% endblock %}