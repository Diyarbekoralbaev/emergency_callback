{% extends 'base.html' %}

{% block title %}{{ title }} - Emergency Callback System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        {% if team %}
            <i class="bi bi-pencil"></i> Edit Team
        {% else %}
            <i class="bi bi-plus-circle"></i> Create Team
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'teams:list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Teams
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="bi bi-people"></i> Team Information
                    {% if team %}
                        <span class="badge bg-info ms-2">ID: {{ team.id }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            <i class="bi bi-tag"></i> Team Name <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Enter a descriptive name for the emergency team (e.g., "Emergency Team Alpha", "Trauma Unit")
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            <i class="bi bi-file-text"></i> Description
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Provide details about the team's specialization and responsibilities
                        </div>
                    </div>

                    {% if team %}
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                   {% if team.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                <i class="bi bi-check-circle"></i> Team is active
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Inactive teams will not appear in callback request forms
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'teams:list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if team %}
                                <i class="bi bi-check-circle"></i> Update Team
                            {% else %}
                                <i class="bi bi-plus-circle"></i> Create Team
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if team %}
        <!-- Team Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="bi bi-bar-chart"></i> Team Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-primary">{{ team.callback_count|default:0 }}</h4>
                        <p class="text-muted mb-0">Total Callbacks</p>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">{{ team.completed_count|default:0 }}</h4>
                        <p class="text-muted mb-0">Completed</p>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-warning">{{ team.rating_count|default:0 }}</h4>
                        <p class="text-muted mb-0">Ratings</p>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info">{{ team.avg_rating|default:"N/A" }}</h4>
                        <p class="text-muted mb-0">Avg Rating</p>
                    </div>
                </div>

                {% if team.callback_count > 0 %}
                <div class="mt-3 text-center">
                    <a href="{% url 'callbacks:list' %}?team={{ team.id }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-list"></i> View All Callbacks
                    </a>
                    <a href="{% url 'callbacks:ratings' %}?team={{ team.id }}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-star"></i> View Ratings
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Team Activity -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="bi bi-clock-history"></i> Recent Activity</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6>Team Created</h6>
                            <p class="mb-1">{{ team.created_at|date:"M d, Y H:i" }}</p>
                            <small class="text-muted">by {{ team.created_by.username }}</small>
                        </div>
                    </div>

                    <!-- Sample activity items -->
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6>Last Callback</h6>
                            <p class="mb-1">Today, 14:30</p>
                            <small class="text-muted">Phone: 998901234567</small>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6>Last Rating</h6>
                            <p class="mb-1">Today, 14:35</p>
                            <small class="text-muted">5 stars received</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Side Panel with Help -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-light">
                <h6><i class="bi bi-lightbulb"></i> Team Setup Tips</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="bi bi-tag"></i> Naming Convention</h6>
                    <ul class="small mb-0">
                        <li>Use clear, descriptive names</li>
                        <li>Include specialization (Trauma, Cardiac, etc.)</li>
                        <li>Consider location or shift (Alpha, Bravo, Night)</li>
                        <li>Keep names under 50 characters</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <h6><i class="bi bi-file-text"></i> Good Descriptions</h6>
                    <ul class="small mb-0">
                        <li>Specify team specializations</li>
                        <li>Include operational hours</li>
                        <li>Mention coverage areas</li>
                        <li>Note special equipment/skills</li>
                    </ul>
                </div>

                <div>
                    <h6><i class="bi bi-gear"></i> Best Practices</h6>
                    <ul class="small mb-0">
                        <li>Deactivate instead of deleting</li>
                        <li>Update descriptions regularly</li>
                        <li>Monitor team performance</li>
                        <li>Train teams on rating system</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-light">
                <h6><i class="bi bi-info-circle"></i> Team Management</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Auto-Generated ID:</strong>
                    <p class="small text-muted">
                        Django automatically assigns a unique ID to each team.
                        This ID is used internally for database relationships and API calls.
                    </p>
                </div>

                <div class="mb-3">
                    <strong>Team Status:</strong>
                    <p class="small text-muted">
                        Active teams appear in callback forms.
                        Inactive teams are hidden but data is preserved.
                    </p>
                </div>

                <div>
                    <strong>Callback Integration:</strong>
                    <p class="small text-muted">
                        Teams are linked to callback requests.
                        Use team ID {{ team.id|default:"(auto-assigned)" }} for API integration.
                    </p>
                </div>
            </div>
        </div>

        {% if team and user.is_staff %}
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h6><i class="bi bi-tools"></i> Admin Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/admin/teams/team/{{ team.id }}/change/" class="btn btn-sm btn-outline-info" target="_blank">
                        <i class="bi bi-gear"></i> Django Admin
                    </a>
                    <button class="btn btn-sm btn-outline-warning" onclick="exportTeamData()">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDeletion()">
                        <i class="bi bi-trash"></i> Delete Team
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -29px;
    top: 17px;
    width: 2px;
    height: calc(100% + 5px);
    background-color: #dee2e6;
}
</style>

<script>
// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const teamName = document.getElementById('id_name').value.trim();

    if (!teamName) {
        alert('Please enter a team name');
        e.preventDefault();
        return;
    }

    if (teamName.length > 100) {
        alert('Team name must be under 100 characters');
        e.preventDefault();
        return;
    }
});

// Character counter for name field
document.getElementById('id_name').addEventListener('input', function(e) {
    const maxLength = 100;
    const currentLength = e.target.value.length;
    const remaining = maxLength - currentLength;

    // Remove existing counter
    const existingCounter = document.querySelector('.char-counter');
    if (existingCounter) {
        existingCounter.remove();
    }

    // Add character counter
    const counter = document.createElement('div');
    counter.className = 'char-counter form-text';
    counter.textContent = `${remaining} characters remaining`;
    if (remaining < 20) {
        counter.classList.add('text-warning');
    }
    if (remaining < 0) {
        counter.classList.add('text-danger');
    }

    e.target.parentNode.appendChild(counter);
});

{% if team %}
function exportTeamData() {
    const teamData = {
        id: {{ team.id }},
        name: "{{ team.name|escapejs }}",
        description: "{{ team.description|escapejs }}",
        is_active: {{ team.is_active|yesno:"true,false" }},
        created_at: "{{ team.created_at|date:'c' }}",
        created_by: "{{ team.created_by.username|escapejs }}"
    };

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(teamData, null, 2));
    const downloadLink = document.createElement('a');
    downloadLink.href = dataStr;
    downloadLink.download = 'team_{{ team.id }}_data.json';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

function confirmDeletion() {
    if (confirm('Are you sure you want to delete this team? This action cannot be undone and will affect all related callback records.')) {
        window.location.href = "{% url 'teams:delete' team.pk %}";
    }
}
{% endif %}
</script>
{% endblock %}